<!DOCTYPE HTML>
<html>
    <head>
        <title>Code Implementation - MARS Robot driving</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="assets/css/main.css" />
        
        <style>
            /* This ensures the code block is centered but the text inside is left-aligned */
            .code-wrapper {
                max-width: 900px;
                margin: 0 auto 2rem auto;
                text-align: left;
                background-color: #272822; /* Monokai-ish dark background */
                border-radius: 6px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                overflow-x: auto; /* Adds scrollbar if code is too wide */
            }

            pre {
                margin: 0;
                padding: 1.5rem;
            }

            code {
                font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                font-size: 0.9em;
                color: #f8f8f2; /* Light text code color */
                line-height: 1.6;
            }

            /* Optional: Syntax highlighting simulation colors */
            .keyword { color: #f92672; font-weight: bold; }
            .func { color: #66d9ef; }
            .string { color: #e6db74; }
            .comment { color: #75715e; font-style: italic; }
        </style>
    </head>
    <body>

        <div id="wrapper" class="divided">

                <section class="banner style1 orient-center content-align-center image-position-center onload-image-fade-in onload-content-fade-right">
                        <div class="content">
                            <h1>Code Implementation</h1>
                            <p class="major">On this page we will explain how we made the robot detect the object, plan the route to get there and eventually publish that command to get to the right place. To complete the mission we also added code for the robot to return back to where it came from.</p>
                            <ul class="actions vertical">
                                <li><a href="index.html#detect" class="button big wide smooth-scroll-middle">Return to Main Page</a></li>
                            </ul>
                        </div>
                        <div class="image">
                            <img src="images/spotlight01.jpg" alt="" />
                        </div>
                    </section>

                <section class="wrapper style1 align-center" id="detection">
                        <div class="inner">
                            <h2>1. Detection Module</h2>
                            <p>This snippet demonstrates how we initialize the computer vision node to identify the ball using color filtering and contour detection.</p>
                            
                            <div class="code-wrapper">
<pre><code><span class="comment"># Detection Node Snippet (Python / ROS2)</span>
Trajectory Determination
    
TF Conversion: Improves on previous TF buffers with persistent buffer in the node which is more efficient for repeated lookups.
# TF Buffer defined in init
self.tf_buffer = tf2_ros.Buffer()
self.tf_listener = tf2_ros.TransformListener(self.tf_buffer, self)

# Looks up the transform
trans = self.tf_buffer.lookup_transform(
    'odom',        # Target frame (world-fixed)
    'base_link',   # Source frame (robot body)
    rclpy.time.Time(),  # Latest available transform
    timeout=rclpy.duration.Duration(seconds=0.1)
)

# Extracts robot's current position
x = trans.transform.translation.x
y = trans.transform.translation.y

def get_current_pose(self):
    """Get current robot pose from TF."""
    try:
        trans = self.tf_buffer.lookup_transform(
            'odom',
            'base_link',
            rclpy.time.Time(),
            timeout=rclpy.duration.Duration(seconds=0.1)
        )
        
        x = trans.transform.translation.x
        y = trans.transform.translation.y
        q = trans.transform.rotation
        roll, pitch, yaw = euler.quat2euler([q.w, q.x, q.y, q.z])
        
        return x, y, yaw
        
    except (tf2_ros.LookupException, tf2_ros.ConnectivityException, tf2_ros.ExtrapolationException) as e:
        self.get_logger().warn(f'[TF] Could not get current pose: {e}')
        return None

#Conversion from quaternion to yaw
q = trans.transform.rotation
roll, pitch, yaw = euler.quat2euler([q.w, q.x, q.y, q.z])

    
Bezier Curve:
# Cubic Bezier Curve Formula
def bezier_curve(self, p0, p1, p2, p3, t):
    """Cubic Bézier interpolation between 4 control points."""
    return (1 - t)**3 * p0 + 3*(1 - t)**2*t*p1 + 3*(1 - t)*t**2*p2 + t**3*p3

# Bezier Curve Waypoint Generation
def generate_bezier_waypoints(self, x1, y1, theta1, x2, y2, theta2):
    """Generate (x, y, theta) waypoints along a smooth Bézier path."""
    
    # Direction vectors from start and end orientations
    d1 = np.array([np.cos(theta1), np.sin(theta1)])
    d2 = np.array([-np.cos(theta2), -np.sin(theta2)])
    
    # Control points offset along those directions
    c1 = np.array([x1, y1]) + self.bezier_offset * d1
    c2 = np.array([x2, y2]) + self.bezier_offset * d2
    
    # Sample points along the curve
    t_vals = np.linspace(0, 1, self.num_waypoints)
    pts = [self.bezier_curve(np.array([x1, y1]), c1, c2, np.array([x2, y2]), t) for t in t_vals]
    
    # Calculate heading (theta) at each point
    thetas = []
    for i in range(len(pts) - 1):
        dx = pts[i+1][0] - pts[i][0]
        dy = pts[i+1][1] - pts[i][1]
        thetas.append(np.arctan2(dy, dx))
    thetas.append(thetas[-1])  # Last point keeps previous heading
    
    return [(pts[i][0], pts[i][1], thetas[i]) for i in range(len(pts))]

PID Controller
Low Pass Filter: Exponential Moving Average (EMA) filter that prevents sudden spikes or oscillations in angular velocity commands. With alpha set to 0.3 it is a balanced response to sudden motion.
# Low-pass filter for angular velocity 
self.filtered_angular_vel = 0.0
self.angular_filter_alpha = 0.3  # Lower = smoother, higher = more responsive

# Raw angular velocity (output from PID)
raw_angular_vel = p_term + i_term + d_term + self.angular_correction

# Low-pass filter for smoothness
self.filtered_angular_vel = (self.angular_filter_alpha * raw_angular_vel + 
                              (1 - self.angular_filter_alpha) * self.filtered_angular_vel)

# Clamp angular velocity
angular_vel = max(-self.max_angular_vel, min(self.max_angular_vel, self.filtered_angular_vel))


Noise Reduction: Uses deadband to ignore errors below threshold. This code prevents excessive correcting happening when the robot is close to the target position.
# Deadband parameter (defined in __init__)
self.angular_deadband = 0.02  # Ignore small errors (0.02 radians = 1.1 degrees)

# Calculate angle error
angle_to_waypoint = math.atan2(dy, dx)
angle_error = self.normalize_angle(angle_to_waypoint - theta)

# Apply deadband to reduce jitter
if abs(angle_error) < self.angular_deadband:
    angle_error = 0.0;
                        
Dynamic Speed Adjustment: Slows the robot down for precise stops to prevent overshooting, reduces speed to prevent skidding, and creates smooth gradual velocity changes.
# Calculate linear velocity
# Slow down when turning or approaching waypoint
turn_factor = max(0.4, 1.0 - abs(angle_error) / (math.pi / 2))
approach_factor = min(1.0, dist / 0.2)  # Slow down within 0.2m of waypoint
linear_vel = self.linear_speed * turn_factor * approach_factor

# Minimum linear velocity to keep moving
linear_vel = max(0.05, linear_vel) 

turn_factor = max(0.4, 1.0 - abs(angle_error) / (math.pi / 2))

approach_factor = min(1.0, dist / 0.2) # Slowing near waypoints 

linear_vel = self.linear_speed * turn_factor * approach_factor # Sets final velocity on approach based on other parameters 

linear_vel = max(0.05, linear_vel) # Prevents robot from stalling



}</code></pre>
                            </div>
                        </div>
                    </section>

                <section class="wrapper style1 align-center" id="actuation">
                        <div class="inner">
                            <h2>3. Actuation (Gripper)</h2>
                            <p>The final step is the mechanical actuation of the gripper to secure the ball. We use PWM signals to control the servo motors.</p>

                            <div class="code-wrapper">
<pre><code><span class="comment"># Servo Control Snippet</span>
<span class="keyword">def</span> <span class="func">activate_gripper</span>(state):
    <span class="keyword">if</span> state == <span class="string">"OPEN"</span>:
        pwm.set_duty_cycle(SERVO_PIN, 7.5) <span class="comment"># Neutral position</span>
        logger.info(<span class="string">"Gripper Opening..."</span>)
        
    <span class="keyword">elif</span> state == <span class="string">"CLOSE"</span>:
        pwm.set_duty_cycle(SERVO_PIN, 12.5) <span class="comment"># 180 degree position</span>
        logger.info(<span class="string">"Gripper Closing..."</span>)
        
    time.sleep(1.0) <span class="comment"># Allow time for mechanical movement</span></code></pre>
                            </div>
                        </div>
                    </section>

                <footer class="wrapper style1 align-center">
                        <div class="inner">
                            <!-- 
                            <ul class="icons">
                                <li><a href="#" class="icon style2 fa-github"><span class="label">GitHub</span></a></li>
                                <li><a href="#" class="icon style2 fa-linkedin"><span class="label">LinkedIn</span></a></li>
                                <li><a href="#" class="icon style2 fa-envelope"><span class="label">Email</span></a></li>
                            </ul>
                            -->
                            <p>&copy; Intro to Robotics Project. Design: <a href="https://html5up.net">HTML5 UP</a>.</p>
                        </div>
                    </footer> 

            </div>

        <script src="assets/js/jquery.min.js"></script>
            <script src="assets/js/jquery.scrollex.min.js"></script>
            <script src="assets/js/jquery.scrolly.min.js"></script>
            <script src="assets/js/skel.min.js"></script>
            <script src="assets/js/util.js"></script>
            <script src="assets/js/main.js"></script>

    </body>
</html>
